<script>
  // BLOCK CART PAGE IF LOGGED OUT
  const userId = localStorage.getItem("user");

  if (!userId) {
    alert("You must be logged in to view your cart.");
    window.location.href = "index.html";
  }

  // Appwrite Config
  const DB_ID = "691b7aec003c0cfc9c2f";  // your database ID
  const COLLECTION_ID = "carts";         // your collection ID (leave if correct)

  // LOAD CART
  function loadCart() {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    let html = "";
    let grand = 0;

    cart.forEach((item, i) => {
      let total = item.qty * item.price;
      grand += total;

      html += `
      <tr>
          <td><button onclick="removeItem(${i})">X</button></td>
          <td><img src="${item.img}" width="80"></td>
          <td>${item.name}</td>
          <td>$${item.price}</td>
          <td><input type="number" value="${item.qty}" min="1" onchange="updateQty(${i}, this.value)"></td>
          <td>$${total}</td>
      </tr>
      `;
    });

    document.getElementById("cart-body").innerHTML = html;
    document.getElementById("grand-total").innerText = "$" + grand;
  }

  // SAVE CART TO APPWRITE
  async function saveCartToAppwrite() {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const total = cart.reduce((sum, p) => sum + p.qty * p.price, 0);

    try {
      // First try to update
      await databases.updateDocument(
        DB_ID,
        COLLECTION_ID,
        userId,
        {
          userId,
          items: JSON.stringify(cart),
          Total: total
        }
      );
    } catch (err) {
      // If document does not exist â†’ create one
      await databases.createDocument(
        DB_ID,
        COLLECTION_ID,
        userId,
        {
          userId,
          items: JSON.stringify(cart),
          Total: total
        }
      );
    }
  }

  // REMOVE ITEM
  function removeItem(index) {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    cart.splice(index, 1);

    localStorage.setItem("cart", JSON.stringify(cart));
    loadCart();
    saveCartToAppwrite();
  }

  // UPDATE QTY
  function updateQty(index, qty) {
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    cart[index].qty = parseInt(qty);

    localStorage.setItem("cart", JSON.stringify(cart));
    loadCart();
    saveCartToAppwrite();
  }

  // INITIAL LOAD
  loadCart();
</script>
